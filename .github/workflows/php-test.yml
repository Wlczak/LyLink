name: PHP Test

on:
    push:
        branches: [main]
    pull_request:
        branches: ["*"]

permissions:
    contents: read
jobs:
    phpunit:
        runs-on: ubuntu-latest
        container:
            image: php:8.5-alpine
        steps:
            - uses: actions/checkout@v4

            - name: Setup PHP dependencies
              run: |
                  curl -sSL https://github.com/php/pie/releases/latest/download/pie.phar >> pie.phar
                  apk add --update linux-headers
                  apk add --no-cache --virtual .build-deps $PHPIZE_DEPS \
                  # && pecl install xdebug \
                  php pie.phar install xdebug/xdebug \
                  && docker-php-ext-enable xdebug \
                  && apk del .build-deps \
                  && echo "xdebug.mode=debug,coverage" >> /usr/local/etc/php/conf.d/99-xdebug.ini

            - name: Install Composer
              run:
                  curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin
                  --filename=composer

            - name: Cache Composer packages
              id: composer-cache
              uses: actions/cache@v3
              with:
                  path: vendor
                  key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}

            - name: Install dependencies
              run: composer install --prefer-dist --no-interaction

            - name: Run PHPUnit
              run:
                  ./vendor/bin/phpunit tests --testdox --colors=always --coverage-text --display-deprecations
                  --display-phpunit-deprecations --fail-on-deprecation --fail-on-phpunit-deprecation
                  --coverage-clover coverage.xml

            - name: Check minimal code coverage
              run: |
                  # Magic ChatGPT script ???
                  set -e

                    COVERAGE_FILE="${1:-coverage.xml}"
                    REQUIRED="${2:-80}"

                    if [ ! -f "$COVERAGE_FILE" ]; then
                      echo "Coverage file not found: $COVERAGE_FILE"
                      exit 1
                    fi

                    if command -v xmlstarlet >/dev/null 2>&1; then
                      COVERED=$(xmlstarlet sel -t -v "/coverage/project/metrics/@coveredstatements" -n "$COVERAGE_FILE" | tr -d '[:space:]')
                      TOTAL=$(xmlstarlet sel -t -v "/coverage/project/metrics/@statements" -n "$COVERAGE_FILE" | tr -d '[:space:]')
                    elif command -v xmllint >/dev/null 2>&1; then
                      COVERED=$(xmllint --xpath 'string(/coverage/project/metrics/@coveredstatements)' "$COVERAGE_FILE" | tr -d '[:space:]')
                      TOTAL=$(xmllint --xpath 'string(/coverage/project/metrics/@statements)' "$COVERAGE_FILE" | tr -d '[:space:]')
                    else
                      echo "xmlstarlet or xmllint is required"
                      exit 1
                    fi

                    if [ -z "$COVERED" ] || [ -z "$TOTAL" ] || [ "$TOTAL" -eq 0 ] 2>/dev/null; then
                      echo "Could not extract coverage values from $COVERAGE_FILE"
                      exit 1
                    fi

                    JSON=$(printf '{"covered":%s,"total":%s}' "$COVERED" "$TOTAL")
                    PERCENT_RAW=$(printf '%s' "$JSON" | jq -r '.covered / .total * 100')
                    PERCENT=$(printf "%.2f" "$PERCENT_RAW")

                    echo "Code coverage: $PERCENT% ($COVERED/$TOTAL)"

                    if printf '%s' "$JSON" | jq -e --arg req "$REQUIRED" '(.covered / .total * 100) >= ($req|tonumber)' >/dev/null; then
                      echo "✅ Code coverage OK (required: $REQUIRED%)"
                      exit 0
                    else
                      echo "❌ Code coverage too low (required: $REQUIRED%)"
                      exit 1
                    fi
